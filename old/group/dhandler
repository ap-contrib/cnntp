<%method title><% $title %></%method>


<%shared>

  $r->content_type('text/html');

  my $title = "";
  my $nntp = $m->comp("_nntp_connect");
  sleep 1 and $nntp = $m->comp("_nntp_connect") unless $nntp;

  #$nntp->reader();

  my ($group, @args) = split /;/, $m->dhandler_arg, 2;

  $group =~ s!/(\d+)?!!;
  my $msgnum = $1 || 0;
  
  $m->clear_buffer,$m->abort(404)
    if ($group =~ m/[^\w.-]/);

  $group =~ s/[^\w.-]//;

  my %args = map { split /=/, $_, 2 } @args;

  my $groups = undef;  # $nntp->newsgroups("$group");
#	warn "GROUP: $group";
  my @group_info = $nntp->group($group);

#  warn "GROUP INFO: ", @group_info;

  $m->clear_buffer,$m->abort(504)
    unless @group_info;  

  my $h2_header;
 if ($msgnum or $args{msgid}) {
   my $max = "";
   #$max = $msgnum + 2 if $msgnum;
   $max = $1 if ($r->header_in("Referer") =~ m/max=(\d+)/);
    $h2_header = qq[<a href="/group/$group] . ($max ? ";max=$max" : "") . qq[">$group</a>];
  } 
  else {
   $h2_header = $group;
  }

 $title = $group;	
 $title = "$group ($msgnum)" if $msgnum;

</%shared>

<%method head>
<link rel="alternate" type="application/rss+xml"
    title="RSS"
    href="/rss/<%$group%>.rdf">
</%method>

<h2><% $h2_header %></h2>

<%perl>
 if (0 and %{$groups}) {
   $m->out(qq[<blockquote><b>Groups under $group ...</b><br>]);
   for my $group (sort keys %{$groups}) {
     $m->out(qq[<a href="$group">$group</a><br>]);
   }
   $m->out(qq[</blockquote>]);
 }

 if ($msgnum or $args{msgid}) {
  $m->comp("_show_article",
	       nntp       => $nntp,
               group      => $group,
  	       msgnum     => $msgnum,
               msgid      => $args{msgid},
	       group_info => \@group_info,
  	       show_headers => $ARGS{show_headers},
               args       => \%args,    
          );
 }
# elsif ($r->connection->remote_ip =~ m/^x(64.81.84.162|216.246.96.102)$/ ) {
#  $m->comp("_show_index_new",
#	        nntp       => $nntp,
#                group      => $group,
#	        group_info => \@group_info,
#                args       => \%args,    
#          );
# }
 elsif ($args{threaded}) {
  $m->comp("_show_index_threaded",
	        nntp       => $nntp,
                group      => $group,
	        group_info => \@group_info,
                args       => \%args,    
	);
 }	
 else {
  $m->comp("_show_index",
	        nntp       => $nntp,
                group      => $group,
	        group_info => \@group_info,
                args       => \%args,    
          );

 }
</%perl>

